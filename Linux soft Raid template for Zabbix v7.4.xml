zabbix_export:
  version: '7.4'
  template_groups:
    - uuid: e960332b3f6c46a1956486d4f3f99fce
      name: 'Templates/Server hardware'
  templates:
    - uuid: d0c0a22f328749749697699f592f1377
      template: 'Linux soft Raid 2.0'
      name: 'Linux soft Raid 2.0'
      groups:
        - name: 'Templates/Server hardware'
      discovery_rules:
        - uuid: 251e1641a0ef436389b41832284ae56f
          name: '{#MDNAME}: Disk members'
          type: DEPENDENT
          key: 'md.disk.members[{#MDNAME}]'
          item_prototypes:
            - uuid: a61025786dc64868a1043348c0765a86
              name: '{#MDNAME}:{#DISKNAME}: slot number'
              key: 'vfs.file.contents[/sys/block/{#MDNAME}/md/dev-{#DISKNAME}/slot]'
              delay: 1h
              value_type: TEXT
              tags:
                - tag: component
                  value: storage
                - tag: disk
                  value: '{#DISKNAME}'
                - tag: raid
                  value: '{#MDNAME}'
            - uuid: 6c5b24906b6a476d8ad12ed809931ffa
              name: '{#MDNAME}:{#DISKNAME}: disk state'
              key: 'vfs.file.contents[/sys/block/{#MDNAME}/md/dev-{#DISKNAME}/state]'
              value_type: TEXT
              preprocessing:
                - type: STR_REPLACE
                  parameters:
                    - in_sync
                    - 'active sync'
              tags:
                - tag: component
                  value: storage
                - tag: disk
                  value: '{#DISKNAME}'
                - tag: raid
                  value: '{#MDNAME}'
              trigger_prototypes:
                - uuid: d7356816dd844bb18235a340efd597d7
                  expression: 'last(/Linux soft Raid 2.0/vfs.file.contents[/sys/block/{#MDNAME}/md/dev-{#DISKNAME}/state],#1)<>last(/Linux soft Raid 2.0/vfs.file.contents[/sys/block/{#MDNAME}/md/dev-{#DISKNAME}/state],#2)'
                  name: '{HOST.NAME} -> {#MDNAME}:{#DISKNAME} - disk state changed!'
                  event_name: '{HOST.NAME} -> {#MDNAME}:{#DISKNAME}  disk state changed from  [ {?last(//vfs.file.contents[/sys/block/{#MDNAME}/md/dev-{#DISKNAME}/state],#2)} ] to [ {?last(//vfs.file.contents[/sys/block/{#MDNAME}/md/dev-{#DISKNAME}/state],#1)} ]'
                  priority: INFO
                  manual_close: 'YES'
          parent_discovery_rule:
            key: 'vfs.dev.discovery[]'
          master_item:
            key: 'vfs.dir.get[/sys/block/{#MDNAME}/md/,dev.+,,dir,,0,,,,,]'
          lld_macro_paths:
            - lld_macro: '{#DISKNAME}'
              path: $.diskname
            - lld_macro: '{#DISKPATH}'
              path: $.diskpath
        - uuid: a70ce577b55a4e8aaa95f52c2cf98da6
          name: 'Soft Raids discovery'
          key: 'vfs.dev.discovery[]'
          delay: 1h
          filter:
            evaltype: AND
            conditions:
              - macro: '{#DEVTYPE}'
                value: disk
              - macro: '{#MDNAME}'
                value: '{$MDNAME.MATCHES}'
          item_prototypes:
            - uuid: 354188ea130143b0959878697d2d6cbf
              name: '{#MDNAME}: Raid members'
              key: 'vfs.dir.get[/sys/block/{#MDNAME}/md/,dev.+,,dir,,0,,,,,]'
              delay: 1h
              value_type: TEXT
              preprocessing:
                - type: JAVASCRIPT
                  parameters:
                    - |
                      var filesystems = JSON.parse(value);
                      
                      result = filesystems.map(function (filesystem) {
                      	return {
                      		'diskname': filesystem.basename
                      	};
                      });
                      
                      return JSON.stringify(result);
                - type: STR_REPLACE
                  parameters:
                    - dev-
                    - ''
              tags:
                - tag: component
                  value: storage
                - tag: raid
                  value: '{$MDNAME}'
            - uuid: d0acb4ef9d7a4111bcb45d36c41aa2f4
              name: '{#MDNAME}: Raid state'
              key: 'vfs.file.contents[/sys/block/{#MDNAME}/md/degraded]'
              trends: '0'
              tags:
                - tag: component
                  value: storage
                - tag: raid
                  value: '{#MDNAME}'
              trigger_prototypes:
                - uuid: 73095fee2ce4462999c004b56fecd634
                  expression: 'last(/Linux soft Raid 2.0/vfs.file.contents[/sys/block/{#MDNAME}/md/degraded])>0'
                  recovery_mode: RECOVERY_EXPRESSION
                  recovery_expression: 'last(/Linux soft Raid 2.0/vfs.file.contents[/sys/block/{#MDNAME}/md/degraded])=0'
                  name: '{HOST.NAME}::{#MDNAME}  is degrated!'
                  priority: AVERAGE
                  tags:
                    - tag: component
                      value: storage
            - uuid: 945ec5587bc44a798f899aca490241d6
              name: '{#MDNAME}: Raid type'
              key: 'vfs.file.contents[/sys/block/{#MDNAME}/md/level]'
              delay: 6h
              value_type: TEXT
              tags:
                - tag: component
                  value: storage
                - tag: raid
                  value: '{#MDNAME}'
            - uuid: 0f90fed2e26e4086a1fb192144cea6e9
              name: '{#MDNAME}: Raid sync state'
              key: 'vfs.file.contents[/sys/block/{#MDNAME}/md/sync_action]'
              value_type: TEXT
              tags:
                - tag: component
                  value: storage
                - tag: raid
                  value: '{#MDNAME}'
              trigger_prototypes:
                - uuid: 0747d2c917124ce3b6568d0328a675f6
                  expression: 'last(/Linux soft Raid 2.0/vfs.file.contents[/sys/block/{#MDNAME}/md/sync_action])="recover"'
                  recovery_mode: RECOVERY_EXPRESSION
                  recovery_expression: 'last(/Linux soft Raid 2.0/vfs.file.contents[/sys/block/{#MDNAME}/md/sync_action])="idle"'
                  name: '{HOST.NAME}::{#MDNAME}  is in sync state'
                  opdata: '{?last(//vfs.file.contents[/sys/block/{#MDNAME}/md/sync_completed])}'
                  priority: WARNING
                  tags:
                    - tag: component
                      value: storage
          preprocessing:
            - type: STR_REPLACE
              parameters:
                - DEVNAME
                - MDNAME
      tags:
        - tag: class
          value: os
        - tag: target
          value: linux
      macros:
        - macro: '{$MDNAME.MATCHES}'
          value: 'md[0-9]+'
